@model IEnumerable<ArkhamChangeRequest.Models.ChangeRequest>

@{
    ViewData["Title"] = "Pending Approvals";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var totalRequests = Model.Count();
    var pendingApprovalCount = Model.Count(cr => cr.Status == ArkhamChangeRequest.Models.ChangeRequestStatus.New);
}

<div class="change-request-container">
    <div class="form-container">
        <h3 class="form-title">Pending Approvals</h3>

        @if (!Model.Any())
        {
            <div class="no-requests">
                <div class="empty-state">
                    <div class="empty-icon">✓</div>
                    <h4>No change requests found</h4>
                    <p>Once the team starts logging changes, they will appear here for review.</p>
                </div>
            </div>
        }
        else
        {
            <div class="requests-summary">
                <p class="summary-text">
                    <strong>@totalRequests</strong> change request@(totalRequests == 1 ? "" : "s") in total |
                    <strong>@pendingApprovalCount</strong> pending approval
                </p>
            </div>

            <div class="requests-list">
                @foreach (var request in Model.OrderByDescending(r => r.CreatedDate))
                {
                    <div class="request-card">
                        <div class="request-header">
                            <div class="request-id">
                                <strong>CR-@request.Id.ToString("D4")</strong>
                                <span class="status-badge status-@request.Status.ToString().ToLower().Replace(" ", "-")">
                                    @request.Status
                                </span>
                            </div>
                            <div class="request-date">
                                Submitted @request.CreatedDate.ToString("MMM dd, yyyy 'at' HH:mm")
                            </div>
                        </div>

                        <div class="request-content">
                            <h4 class="request-title">@request.ChangeTitle</h4>
                            <p class="request-description">
                                @if (!string.IsNullOrWhiteSpace(request.ChangeDescription) && request.ChangeDescription.Length > 200)
                                {
                                    @(request.ChangeDescription.Substring(0, 200) + "…")
                                }
                                else
                                {
                                    @request.ChangeDescription
                                }
                            </p>

                            <div class="request-details">
                                <div class="detail-item">
                                    <span class="detail-label">Requestor:</span>
                                    <span class="detail-value">@request.RequestorName (@request.RequestorEmail)</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Priority:</span>
                                    <span class="priority-badge priority-@request.Priority.ToString().ToLower()">
                                        @request.Priority
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Service:</span>
                                    <span class="detail-value">@request.AuthorizationServiceAffected</span>
                                </div>
                            </div>

                            @if (request.AttachmentFiles?.Any() == true)
                            {
                                <div class="attachments-info">
                                    <span>@request.AttachmentFiles.Count attachment@(request.AttachmentFiles.Count == 1 ? "" : "s")</span>
                                </div>
                            }
                        </div>

                        <div class="request-actions">
                            <a href="@Url.Action("Details", "ChangeRequest", new { id = request.Id })" class="btn btn-outline btn-sm">
                                View Details
                            </a>
                            @if (request.Status == ArkhamChangeRequest.Models.ChangeRequestStatus.New)
                            {
                                <a href="@Url.Action("Approve", "ChangeRequest", new { id = request.Id })" class="btn btn-primary btn-sm">
                                    Review &amp; Approve
                                </a>
                            }
                            @if (request.Status == ArkhamChangeRequest.Models.ChangeRequestStatus.Approved ||
                                 request.Status == ArkhamChangeRequest.Models.ChangeRequestStatus.OnHold)
                            {
                                <a href="@Url.Action("UpdateStatus", "ChangeRequest", new { id = request.Id })" class="btn btn-secondary btn-sm">
                                    Update Status
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>
